# シャドウィング練習アプリ 完全技術仕様書 v2.0

## 変更履歴
- v2.0 (2025/07/04): 開発実装後の知見を反映して更新

## 1. アプリ概要

### 1.1 目的
日本人の英語学習者向けに、シャドウィング（音声を聞きながら同時に発音する練習法）と音読練習を通じて、英語の発音を改善するiOSアプリ。**自分で録音した教材**（映画、ニュース、会話など）を使って練習できる柔軟性を提供する。

### 1.2 ターゲットユーザー
- 日本人の英語学習者
- 英語の発音を改善したい人
- TOEICやビジネス英語の発音練習をしたい人
- 自分で録音した映画やニュースのワンシーンなどを教材にしたい人

### 1.3 主要機能
1. **教材作成機能**
   - a. 音声ファイル取り込み（mp3/wav/m4a）
   - b. その場で教材音声を録音して追加
2. **音声認識機能**：教材・練習音声ともに文字起こし（英語のみ）
3. **練習モード**：音読練習とシャドウィング練習
4. **評価機能**：発音の正確性を評価し、フィードバックを提供
5. **Diff（差分）表示機能**：ユーザー発話と教材テキストの差異を視覚的に表示

## 2. 技術仕様

### 2.1 開発環境
- **IDE**: Xcode 16.3以降
- **言語**: Swift 5.0以降
- **最小iOS**: iOS 17.0（実装の安定性を考慮して変更）
- **UI Framework**: SwiftUI
- **アーキテクチャ**: MVVM + Services層

### 2.2 使用フレームワーク
- **AVFoundation**: 音声録音・再生・ファイル処理
- **Speech Framework**: 音声認識（Apple標準）
- **Combine**: リアクティブプログラミング
- **UniformTypeIdentifiers**: ファイルタイプ判定
- **DocumentPicker**: ファイル選択UI

### 2.3 外部依存
- 現在なし（Diff表示はSwiftUI内で実装）
- 将来的にOpenAI Whisper API連携を検討

### 2.4 【新規】プロジェクト構造
```
ShadowingPractice/
├── App/
│   ├── ShadowingPracticeApp.swift
│   └── Info.plist
├── Core/
│   ├── Models/
│   │   ├── Material.swift
│   │   ├── PracticeSession.swift
│   │   ├── PracticeResult.swift
│   │   └── WordAnalysis.swift
│   ├── Services/
│   │   ├── AudioRecorder.swift
│   │   ├── SpeechRecognizer.swift
│   │   ├── MaterialService.swift
│   │   └── TextComparisonService.swift
│   └── Utilities/
│       ├── FileManager+Extensions.swift
│       └── Logger.swift
├── Features/
│   ├── Materials/
│   ├── Practice/
│   ├── History/
│   └── Settings/
└── Shared/
    ├── Views/
    └── Extensions/
```

## 3. 機能詳細

### 3.1 教材作成機能

#### 3.1.1 音声ファイルインポート

**対応フォーマット**
```swift
let supportedTypes: [UTType] = [
    .mp3,           // MP3オーディオ
    .wav,           // WAVオーディオ
    .m4a,           // MPEG-4オーディオ
    .aiff,          // AIFFオーディオ
    .item           // その他のオーディオタイプ
]
```

**ファイル制限**
- 最大サイズ: 100MB
- 最大長さ: 10分（600秒）
- 最小長さ: 1秒

**【更新】インポート処理フロー**
1. DocumentPickerでファイル選択（`asCopy: true`で安全なコピー）
2. ファイルバリデーション（形式、サイズ、長さ）
3. Documentsディレクトリに`materials/[UUID].[ext]`として保存
4. メタデータ（タイトル、作成日時）を記録
5. バックグラウンドで自動文字起こし開始
6. **文字起こし進捗をUIに反映**

#### 3.1.2 その場で教材録音

**録音設定**
```swift
let recordingSettings: [String: Any] = [
    AVFormatIDKey: Int(kAudioFormatMPEG4AAC),
    AVSampleRateKey: 44100.0,
    AVNumberOfChannelsKey: 1,  // モノラル（ファイルサイズ節約）
    AVEncoderAudioQualityKey: AVAudioQuality.high.rawValue,
    AVEncoderBitRateKey: 128000  // 128kbps
]
```

**【新規】録音UI/UX**
- カウントダウン表示（3秒）
- リアルタイム音声レベルメーター
- 録音時間表示（0.1秒単位）
- プレビュー再生機能
- 録り直しオプション

### 3.2 音声認識機能

#### 3.2.1 【更新】SpeechRecognizer 実装方針

**権限管理**
- アプリ起動時に権限をリクエスト
- 権限拒否時の適切なエラーメッセージ
- 設定アプリへの誘導

**認識精度向上策**
```swift
request.shouldReportPartialResults = true
request.taskHint = .dictation  // 長文認識に最適化
request.requiresOnDeviceRecognition = false  // オンライン認識で精度向上
request.addsPunctuation = true  // iOS 16以降
```

**【新規】エラーハンドリング**
- ネットワーク接続エラー
- 言語サポートエラー
- タイムアウト処理
- 空の認識結果への対処

### 3.3 練習モード

#### 3.3.1 【更新】音読モード
1. 教材選択（最近使った教材を優先表示）
2. 教材テキスト表示（**フォントサイズ調整機能**）
3. 録音開始（カウントダウン3秒）
4. 録音中は経過時間とレベルメーター表示
5. 停止で自動評価開始
6. 結果表示（スコア、Diff、フィードバック）

#### 3.3.2 【更新】シャドウィングモード
1. 教材選択
2. 再生コントロール表示
   - 再生/一時停止
   - 10秒戻る/進む
   - 速度調整（0.5x〜2.0x）
   - **ループ設定（全体リピート）**
3. **再生開始と同期して録音開始（0.5秒遅延）**
4. 教材終了で自動的に録音停止
5. 自動評価開始
6. 結果表示

### 3.4 評価機能

#### 3.4.1 【新規】評価メトリクス
- **正確性スコア**：0-100点
- **単語エラー率**：WER（Word Error Rate）
- **認識単語数**：総単語数カウント
- **練習時間**：ミリ秒単位で記録
- **WPM**：Words Per Minute（流暢さ指標）

#### 3.4.2 【新規】フィードバック生成
```swift
// スコアベースのフィードバック
if result.accuracy >= 80 {
    "単語の認識率が高く、正確に発音できています"
}
if result.wordsPerMinute >= 100 {
    "適切なスピードで話せています"
}
if result.accuracy < 70 {
    "もう少しゆっくり、はっきりと発音してみましょう"
}
```

### 3.5 Diff（差分）表示機能

#### 3.5.1 【更新】SwiftUI実装
- **WrappingHStack**で単語の自然な折り返し
- **アニメーション**付き表示（各単語が順番に表示）
- **カラーコーディング**：
  - 正解：デフォルトカラー
  - 削除：赤文字 + 取り消し線
  - 挿入：緑背景
  - 置換：赤取り消し線 → 緑文字

#### 3.5.2 【新規】差分統計表示
- 正解/置換/削除/挿入の単語数
- パーセンテージ表示
- ビジュアルな統計グラフ

## 4. 【新規】データ管理

### 4.1 ファイル構造
```
Documents/
├── materials/          # 教材ファイル
│   └── [UUID].m4a     # 教材音声
├── practices/         # 練習録音
│   └── [UUID].m4a     # 練習音声
└── metadata/          # メタデータ
    └── sessions/      # 練習結果JSON
```

### 4.2 データ永続化
- **UserDefaults**：設定値、選択状態
- **FileManager**：音声ファイル管理
- **JSON + Codable**：練習結果、教材メタデータ

### 4.3 【新規】メモリ管理
- 音声ファイルの適切な解放
- Viewの@StateObject使用によるメモリリーク防止
- バックグラウンドタスクのキャンセル処理

## 5. 【新規】UI/UX設計

### 5.1 ナビゲーション
- **TabView**による4画面構成
  1. 教材（Materials）
  2. 練習（Practice）
  3. 履歴（History）
  4. 設定（Settings）

### 5.2 デザインシステム
- **カラー**：システムカラー使用（ダークモード対応）
- **フォント**：Dynamic Type対応
- **アニメーション**：
  - 録音ボタンのパルス
  - 結果表示のトランジション
  - Diff表示の順次アニメーション

### 5.3 エラー表示
- **インラインエラー**：フォーム入力
- **アラート**：重要なエラー
- **トースト**：一時的な通知（将来実装）

## 6. 【新規】パフォーマンス最適化

### 6.1 音声処理
- AVAudioSessionの適切な管理
- バックグラウンドでの音声認識
- 録音と再生の競合回避

### 6.2 UI最適化
- LazyVStackによる大量データ表示
- 画像・アイコンのキャッシュ
- 非同期処理による UI ブロッキング防止

## 7. 【新規】セキュリティとプライバシー

### 7.1 権限管理
```xml
<key>NSMicrophoneUsageDescription</key>
<string>このアプリは発音練習のために音声を録音します。録音された音声はデバイス内でのみ処理され、外部に送信されることはありません。</string>
<key>NSSpeechRecognitionUsageDescription</key>
<string>このアプリは録音した音声を文字起こしして、発音の正確性を評価します。音声認識はデバイス内で行われます。</string>
```

### 7.2 データ保護
- 音声データはデバイス内完結
- iCloudバックアップ：オプトイン
- 外部送信なし（Apple Speech使用時）

## 8. 【新規】エラーハンドリング戦略

### 8.1 エラーの分類
1. **回復可能エラー**：
   - ファイル形式エラー → 別ファイル選択を促す
   - 録音中断 → 再試行オプション提供

2. **ユーザーアクション必要**：
   - 権限エラー → 設定アプリへ誘導
   - ストレージ不足 → クリーンアップ提案

3. **致命的エラー**：
   - アプリクラッシュ防止
   - 適切なログ記録

### 8.2 ユーザーフィードバック
- 具体的なエラーメッセージ
- 解決方法の提示
- 再試行オプション

## 9. 【新規】テスト戦略

### 9.1 必須テストケース
- [ ] 各種音声フォーマットのインポート
- [ ] 最大ファイルサイズ（100MB）のインポート
- [ ] 権限拒否時の動作
- [ ] ネットワーク切断時の音声認識
- [ ] バックグラウンド移行時の録音処理
- [ ] 長時間録音のメモリ使用量

### 9.2 デバイステスト
- iPhone SE（小画面）
- iPhone 15 Pro（最新）
- iOS 17.0（最小サポート）
- iOS 18.4（最新）

## 10. 【新規】今後の拡張計画

### 10.1 Phase 1（リリース後3ヶ月）
- [ ] iPad対応
- [ ] 練習リマインダー通知
- [ ] CSV形式での練習履歴エクスポート
- [ ] 詳細な音声波形表示

### 10.2 Phase 2（6ヶ月）
- [ ] OpenAI Whisper API統合
- [ ] 多言語対応（日本語、中国語）
- [ ] 教材の共有機能
- [ ] クラウドバックアップ

### 10.3 Phase 3（1年）
- [ ] AI発音コーチング
- [ ] リアルタイム発音矯正
- [ ] ソーシャル機能（ランキング等）
- [ ] 教材マーケットプレイス

## 11. 【新規】既知の制限事項

### 11.1 技術的制限
- Apple Speech Recognitionは英語のみ対応
- オフライン認識は精度が低下
- 10分以上の音声ファイルは非対応
- 同時録音・再生には制限あり

### 11.2 UX上の制限
- 文字起こしがない教材では音読練習不可
- バックグラウンドでの連続録音は不可
- 複数デバイス間の同期は未対応

## 12. 【新規】リリース準備チェックリスト

### 12.1 技術面
- [x] メモリリークがない
- [x] 全エラーケースでの適切なメッセージ
- [x] オフライン時の動作確認
- [x] 権限リクエストの実装

### 12.2 App Store対応
- [ ] アプリアイコン（1024x1024）
- [ ] スクリーンショット（6.7", 6.1", 5.5"）
- [ ] アプリ説明文（日本語/英語）
- [ ] キーワード最適化
- [x] プライバシーポリシーURL
- [x] 年齢制限設定（4+）

### 12.3 品質保証
- [ ] Crashlyticsの統合
- [ ] TestFlightでのベータテスト
- [ ] パフォーマンスプロファイリング
- [ ] アクセシビリティチェック

---

この仕様書v2.0は、実装経験に基づいて更新されました。
主な変更点：
- より現実的な技術仕様
- 詳細なエラーハンドリング
- UI/UXの具体的な実装方針
- テスト戦略の明確化
- 既知の制限事項の文書化